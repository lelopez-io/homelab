---
clusterName: homelab-cluster
talosVersion: v1.11.6
kubernetesVersion: v1.34.1
endpoint: https://192.168.10.30:6443
allowSchedulingOnControlPlanes: true

clusterPodNets:
  - 10.244.0.0/16
clusterSvcNets:
  - 10.96.0.0/12

cniConfig:
  name: flannel

cluster:
  etcd:
    advertisedSubnets:
      - 192.168.10.0/24

# DRA feature gates for control plane components
controlPlane:
  patches:
    - |-
      cluster:
        apiServer:
          extraArgs:
            feature-gates: DynamicResourceAllocation=true
            runtime-config: resource.k8s.io/v1=true
        controllerManager:
          extraArgs:
            feature-gates: DynamicResourceAllocation=true
        scheduler:
          extraArgs:
            feature-gates: DynamicResourceAllocation=true


nodes:
  - hostname: talos-node-1
    ipAddress: 192.168.10.30
    controlPlane: true
    installDiskSelector:
      size: ">= 2TB"
      model: WPBSN4M8-2TGP
    networkInterfaces:
      - interface: enp172s0
        addresses:
          - 192.168.10.30/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/i915         # Intel GPU drivers
            - siderolabs/intel-ucode  # Intel CPU microcode
            - siderolabs/iscsi-tools  # iSCSI storage drivers
    patches:
      - |-
        machine:
          kubelet:
            extraArgs:
              feature-gates: DynamicResourceAllocation=true
          files:
            - path: /etc/cri/conf.d/20-customization.part
              op: create
              content: |
                [plugins."io.containerd.cri.v1.runtime"]
                  cdi_spec_dirs = ["/var/run/cdi"]

  - hostname: talos-node-2
    ipAddress: 192.168.10.31
    controlPlane: true
    installDiskSelector:
      size: ">= 2TB"
      model: WPBSN4M8-2TGP
    networkInterfaces:
      - interface: enp172s0
        addresses:
          - 192.168.10.31/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/i915         # Intel GPU drivers
            - siderolabs/intel-ucode  # Intel CPU microcode
            - siderolabs/iscsi-tools  # iSCSI storage drivers
    patches:
      - |-
        machine:
          kubelet:
            extraArgs:
              feature-gates: DynamicResourceAllocation=true
          files:
            - path: /etc/cri/conf.d/20-customization.part
              op: create
              content: |
                [plugins."io.containerd.cri.v1.runtime"]
                  cdi_spec_dirs = ["/var/run/cdi"]

  - hostname: talos-node-3
    ipAddress: 192.168.10.32
    controlPlane: true
    installDiskSelector:
      size: ">= 2TB"
      model: WPBSN4M8-2TGP
    networkInterfaces:
      - interface: enp172s0
        addresses:
          - 192.168.10.32/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/i915         # Intel GPU drivers
            - siderolabs/intel-ucode  # Intel CPU microcode
            - siderolabs/iscsi-tools  # iSCSI storage drivers
    patches:
      - |-
        machine:
          kubelet:
            extraArgs:
              feature-gates: DynamicResourceAllocation=true
          files:
            - path: /etc/cri/conf.d/20-customization.part
              op: create
              content: |
                [plugins."io.containerd.cri.v1.runtime"]
                  cdi_spec_dirs = ["/var/run/cdi"]
